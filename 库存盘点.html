<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>库存盘点</title>
<style>
    body{font-family:"微软雅黑";background:#f5f5f5;margin:0;padding:20px}
    .box{width:900px;margin:0 auto;background:#fff;padding:20px;border:1px solid #ddd}
    h2{margin:0 0 15px;font-size:20px;color:#333}
    .search-bar{margin-bottom:15px}
    .search-bar input{padding:6px 8px;width:220px;margin-right:8px;border:1px solid #ccc}
    .search-bar button{padding:6px 12px;background:#2c7eda;color:#fff;border:none;cursor:pointer}
    table{width:100%;border-collapse:collapse;font-size:14px;margin-top:10px}
    th,td{border:1px solid #ddd;padding:8px;text-align:center}
    th{background:#f7f7f7}
    .even{background:#fafafa}
    .btn-save{padding:8px 20px;background:#2c7eda;color:#fff;border:none;cursor:pointer;margin-top:15px}
    .btn-save:hover{background:#236bb0}
    .required::after{content:" *";color:red}
    .short-input{width:80px;text-align:center}
</style>
</head>
<body>
<div class="box">
    <h2>库存盘点</h2>
    <div class="search-bar">
        <input type="text" id="key" placeholder="请输入商品名称或编码" />
        <button onclick="searchStock()">查询库存</button>
        <button onclick="addRow()" style="margin-left:8px;background:#5cb85c">新增盘点行</button>
    </div>

    <table id="stockTable">
        <thead>
            <tr>
                <th>商品编码</th>
                <th>商品名称</th>
                <th>规格型号</th>
                <th>单位</th>
                <th>系统库存</th>
                <th>实盘数量</th>
                <th>盈亏数量</th>
                <th>操作</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <button class="btn-save" onclick="saveCheck()">保存盘点结果</button>
</div>

<script>
// 模拟库存数据
const stockData = [
    {code:"P001",name:"台式电脑",spec:"i5/8G/256G",unit:"台",qty:30},
    {code:"P002",name:"激光打印机",spec:"A4黑白",unit:"台",qty:12},
    {code:"P003",name:"无线鼠标",spec:"2.4G",unit:"个",qty:200},
    {code:"P004",name:"机械键盘",spec:"104键青轴",unit:"个",qty:85}
];

let checkList = []; // 当前盘点列表

// 查询库存
function searchStock(){
    const key = document.getElementById("key").value.trim().toLowerCase();
    if(!key){alert("请输入关键词");return;}
    const found = stockData.filter(s =>
        s.code.toLowerCase().includes(key) || s.name.toLowerCase().includes(key)
    );
    if(found.length === 0){alert("未找到商品");return;}
    // 将查询结果加入盘点列表（去重）
    found.forEach(f=>{
        if(!checkList.some(c=>c.code===f.code)) checkList.push({...f,real:0,diff:0});
    });
    renderTable();
    document.getElementById("key").value = "";
}

// 新增空白盘点行
function addRow(){
    const empty = {code:"",name:"",spec:"",unit:"",qty:0,real:0,diff:0};
    checkList.push(empty);
    renderTable();
}

// 渲染表格
function renderTable(){
    const tbody = document.querySelector("#stockTable tbody");
    tbody.innerHTML = "";
    checkList.forEach((item,index)=>{
        const tr = document.createElement("tr");
        tr.className = index % 2 === 0 ? "even" : "";
        tr.innerHTML = `
            <td><input type="text" class="required" value="${item.code}" onchange="updateItem(${index},'code',this.value)" /></td>
            <td><input type="text" class="required" value="${item.name}" onchange="updateItem(${index},'name',this.value)" /></td>
            <td><input type="text" value="${item.spec}" onchange="updateItem(${index},'spec',this.value)" /></td>
            <td><input type="text" value="${item.unit}" onchange="updateItem(${index},'unit',this.value)" /></td>
            <td>${item.qty}</td>
            <td><input type="number" min="0" class="short-input required" value="${item.real}" onchange="updateItem(${index},'real',this.value)" onblur="calcDiff(${index})" /></td>
            <td style="color:${item.diff>0?'green':item.diff<0?'red':'#333'}">${item.diff}</td>
            <td><button class="btn-del" onclick="delRow(${index})">删除</button></td>
        `;
        tbody.appendChild(tr);
    });
}

// 更新对象属性
function updateItem(index,field,value){
    checkList[index][field] = value;
}

// 计算盈亏
function calcDiff(index){
    const item = checkList[index];
    item.diff = (parseFloat(item.real)||0) - item.qty;
    renderTable(); // 刷新显示盈亏
}

// 删除行
function delRow(index){
    if(confirm("确定删除此行？")){
        checkList.splice(index,1);
        renderTable();
    }
}

// 保存盘点结果
function saveCheck(){
    // 必填校验
    for(let i=0;i<checkList.length;i++){
        const it = checkList[i];
        if(!it.code || !it.name || it.real===""){
            alert("第"+(i+1)+"行：商品编码、名称、实盘数量为必填项！");
            return;
        }
    }
    console.log("盘点结果：",checkList);
    alert("盘点结果已保存！\n"+JSON.stringify(checkList,null,2));
}

// 初始加载空表
renderTable();
</script>
</body>
</html>